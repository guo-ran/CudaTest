NVIDIA Apex提供了LayerNorm的高性能fuse版本实现，这里用OneFlow和Apex LayerNorm进行对比，Apex版本为：commit aa756cec4359aff3df1d9abb68dc6e6e92920e0c Thu Nov 18 23:05:40 2021 -0800

测试用例： num_rows固定为49152, num_cols 由32-32768变化。

#### 性能表格前向：

**NVIDIA A100-PCIE-40GB** Kernel的执行时间，单位us，越小越好

|         | 32     | 64     | 128    | 256    | 512    | 1024   | 2048   | 4096   | 8192 | 16384 | 32768 |
| ------- | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ---- | ----- | ----- |
| OneFlow | 17.12  | 29.41  | 57.22  | 66.5   | 93.41  | 154.56 | 329.95 | 938.72 | 1910 | 4660  | 7760  |
| Apex    | 188.19 | 191.04 | 195.46 | 206.27 | 252.19 | 349.73 | 541.89 | 1040   | 2630 | 5470  | 11090 |


#### 性能表格后向求dx：

**NVIDIA A100-PCIE-40GB** Kernel的执行时间，单位us，越小越好

|         | 32     | 64     | 128    | 256    | 512    | 1024   | 2048   | 4096 | 8192 | 16384 | 32768 |
| ------- | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ---- | ---- | ----- | ----- |
| OneFlow | 18.85  | 30.08  | 41.15  | 58.59  | 110.11 | 218.24 | 489.47 | 1070 | 3660 | 6120  | 13290 |
| Apex    | 125.54 | 129.98 | 139.71 | 172.29 | 243.14 | 400    | 827.62 | 1960 | 4160 | 8250  | 16600 |

#### TODO paramGrad性能对比

注：测试发现前向时cols=2048时用warp实现可以启动且性能比SharedMemory实现好很多，因此前向判断条件是<=2048
后向时cols=2048用warp实现启动不起来，后向判断条件是<=1024

测试代码在:[代码](../code/layer_norm/) 下


PyTorch kernel不支持half类型，做了一组float类型的前向对照，**NVIDIA A100-PCIE-40GB** Kernel的执行时间，单位us，越小越好
下面的PyTorch时间是RowwiseMomentsCUDAKernel+LayerNormForwardCUDAKernel时间

|                                    | 32     | 64     | 128    | 256    | 512    | 1024   | 2048    | 4096 | 8192 | 16384 | 32768 |
| ---------------------------------- | ------ | ------ | ------ | ------ | ------ | ------ | ------- | ---- | ---- | ----- | ----- |
| OneFlow                            | 18.59  | 28.64  | 51.78  | 80.19  | 146.46 | 296.70 | 587.90  | 1180 | 2380 | 5360  | 10940 |
| Apex                               | 219.71 | 222.88 | 224.42 | 255.62 | 297.63 | 409.60 | 728     | 1640 | 3980 | 8070  | 16410 |
| PyTorch                            | 391.71 | 394.24 | 402.36 | 439.52 | 534.24 | 899.84 | 1366.53 | 2510 | 4780 | 9490  | 19450 |
| PyTorch RowwiseMomentsCUDAKernel   | 317.60 | 319.49 | 325.02 | 329.82 | 342.88 | 436.06 | 636.61  | 1050 | 1890 | 3600  | 7080  |
| PyTorch LayerNormForwardCUDAKernel | 74.11  | 74.75  | 77.34  | 109.70 | 191.36 | 365.60 | 729.92  | 1460 | 2890 | 5890  | 12370 |
|                                    |        |        |        |        |        |        |         |      |      |       |       |

